<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pageant Scoring System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom animations */
        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(360deg); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .flip-animation {
            animation: flip 3s ease-in-out infinite;
        }
        
        .fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }
        
        .pulse-hover:hover {
            animation: pulse 0.3s ease-in-out;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .locked-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <!-- Lock Overlay -->
    <div id="lockOverlay" class="locked-overlay hidden">
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 text-center max-w-md">
            <h3 class="text-2xl font-bold text-white mb-4">üîí Page Locked</h3>
            <p id="lockMessage" class="text-white/80 mb-6"></p>
            <div class="flex gap-4 justify-center">
                <button onclick="checkLockStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">Check Again</button>
                <button onclick="showPage('home')" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors">Go Home</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white/10 backdrop-blur-md border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-white">Pageant Scoring System</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showPage('home')" class="text-white hover:text-green-200 px-3 py-2 rounded-md text-sm font-medium transition-colors">Home</button>
                    <button onclick="showPage('admin')" class="text-white hover:text-green-200 px-3 py-2 rounded-md text-sm font-medium transition-colors">Admin</button>
                    <div id="sessionIndicator" class="text-xs text-white/60"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="homePage" class="page">
        <div class="max-w-4xl mx-auto px-4 py-16 text-center">
            <!-- Animated Logo Placeholder -->
            <div class="mb-12 fade-in-up">
                <div class="flip-animation mx-auto w-32 h-32 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center border-4 border-white/30">
                    <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                </div>
            </div>
            
            <h1 class="text-5xl font-bold text-white mb-6 fade-in-up">Beauty Pageant</h1>
            <h2 class="text-3xl font-light text-white/90 mb-12 fade-in-up">Scoring System</h2>
            
            <div class="grid md:grid-cols-2 gap-8 mb-12">
                <!-- Judge Access Cards -->
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 card-hover fade-in-up">
                    <h3 class="text-2xl font-bold text-white mb-6">Judge Access</h3>
                    <div id="judgeButtons" class="grid grid-cols-2 gap-4">
                        <!-- Judge buttons will be generated here -->
                    </div>
                </div>
                
                <!-- Admin Access Card -->
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 card-hover fade-in-up">
                    <h3 class="text-2xl font-bold text-white mb-6">Administration</h3>
                    <button onclick="showAdminPage()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-lg transition-colors pulse-hover w-full">
                        View Rankings & Results
                    </button>
                </div>
            </div>

            <!-- Session Status -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 fade-in-up">
                <h3 class="text-lg font-bold text-white mb-4">Current Session Status</h3>
                <div id="sessionStatus" class="grid md:grid-cols-2 gap-4 text-sm">
                    <!-- Session status will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Judge Scoring Page -->
    <div id="judgePage" class="page hidden">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 mb-8">
                <h2 id="judgeTitle" class="text-3xl font-bold text-white mb-4">Judge Scoring Panel</h2>
                <div class="flex flex-wrap gap-4 mb-6">
                    <button onclick="saveAllScores()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">üíæ Save All Scores</button>
                    <button onclick="exportJudgeScoresheet()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">üìä Export My Scoresheet</button>
                    <button onclick="showPage('home')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Back to Home</button>
                </div>
                <div id="sessionWarning" class="bg-green-600/20 border border-green-500/30 rounded-lg p-4 mb-4 hidden">
                    <p class="text-green-200">‚úÖ Your session is active for 1 hour. Time remaining: <span id="timeRemaining"></span> minutes.</p>
                </div>
            </div>
            
            <!-- Contestants Grid -->
            <div id="contestantsGrid" class="grid gap-8">
                <!-- Contestant scoring cards will be generated here -->
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="page hidden">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <!-- Admin Controls -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 mb-8">
                <h2 class="text-3xl font-bold text-white mb-6">Admin Dashboard</h2>
                
                <!-- Session Override -->
                <div class="bg-red-600/20 border border-red-500/30 rounded-lg p-4 mb-6">
                    <h4 class="text-white font-bold mb-2">üîì Emergency Session Management</h4>
                    <div class="flex gap-2">
                        <button onclick="forceUnlockAll()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">Force Unlock All</button>
                        <button onclick="viewActiveSessions()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">View Active Sessions</button>
                    </div>
                </div>
                
                <!-- Management Section -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- Judge Management -->
                    <div class="bg-white/10 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Manage Judges</h3>
                        <div class="space-y-4">
                            <div class="flex gap-2">
                                <input type="text" id="judgeNameInput" placeholder="Judge Name (optional)" 
                                       class="flex-1 bg-white/20 text-white rounded-lg px-3 py-2 border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-white/60">
                                <button onclick="addJudge()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">Add Judge</button>
                            </div>
                            <div id="judgesList" class="space-y-2">
                                <!-- Current judges will be listed here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contestant Management -->
                    <div class="bg-white/10 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Manage Contestants</h3>
                        <div class="space-y-4">
                            <div class="flex gap-2">
                                <input type="text" id="contestantNameInput" placeholder="Contestant Name" 
                                       class="flex-1 bg-white/20 text-white rounded-lg px-3 py-2 border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-white/60">
                                <button onclick="addContestant()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">Add</button>
                            </div>
                            <div id="contestantsList" class="space-y-2">
                                <!-- Current contestants will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4 mb-8">
                    <button onclick="calculateResults()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Calculate Results</button>
                    <button onclick="exportToCSV()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Export Combined Results</button>
                    <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Clear All Data</button>
                    <button onclick="showPage('home')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Back to Home</button>
                </div>
                
                <!-- Individual Judge Scoresheets -->
                <div class="bg-white/10 rounded-lg p-6 mb-8">
                    <h3 class="text-xl font-bold text-white mb-4">üìä Individual Judge Scoresheets</h3>
                    <p class="text-white/80 text-sm mb-4">Export individual judge scoresheets for detailed analysis:</p>
                    <div id="judgeExportButtons" class="grid md:grid-cols-2 lg:grid-cols-4 gap-3">
                        <!-- Judge export buttons will be generated here -->
                    </div>
                </div>
            </div>
            
            <!-- Winner Announcement -->
            <div id="winnerAnnouncement" class="bg-gradient-to-r from-yellow-600/20 to-purple-600/20 backdrop-blur-md rounded-xl p-8 mb-8 border-2 border-yellow-400/50 hidden">
                <div class="text-center">
                    <h2 class="text-4xl font-bold text-yellow-400 mb-4">üèÜ WINNER ANNOUNCED! üèÜ</h2>
                    <div id="winnerDetails" class="text-2xl text-white mb-6">
                        <!-- Winner details will be shown here -->
                    </div>
                    <div id="topThree" class="grid md:grid-cols-3 gap-6 mt-8">
                        <!-- Top 3 will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Import/Export Section -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 mb-8">
                <h3 class="text-2xl font-bold text-white mb-6">üìä Import & Export Data</h3>
                
                <!-- Import Section -->
                <div class="grid md:grid-cols-2 gap-8 mb-6">
                    <div class="bg-white/10 rounded-lg p-6">
                        <h4 class="text-lg font-bold text-white mb-4">üì• Import Scoresheet</h4>
                        <p class="text-white/80 text-sm mb-4">Import CSV files from other devices or backup scoresheets:</p>
                        <div class="space-y-3">
                            <input type="file" id="csvFileInput" accept=".csv" 
                                   class="block w-full text-sm text-white bg-white/20 border border-white/30 rounded-lg cursor-pointer focus:outline-none">
                            <button onclick="importCSV()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                                Import CSV Data
                            </button>
                        </div>
                        <div class="mt-4 text-xs text-white/60">
                            <p>‚Ä¢ Supports individual judge scoresheets</p>
                            <p>‚Ä¢ Automatically merges with existing data</p>
                            <p>‚Ä¢ Validates data format before import</p>
                        </div>
                    </div>
                    
                    <div class="bg-white/10 rounded-lg p-6">
                        <h4 class="text-lg font-bold text-white mb-4">üì§ Export Options</h4>
                        <div class="space-y-3">
                            <button onclick="exportMasterScoresheet()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                                üìã Master Scoresheet (All Data)
                            </button>
                            <button onclick="exportFinalResults()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                                üèÜ Final Results Summary
                            </button>
                            <button onclick="exportCategoryBreakdown()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors w-full">
                                üìä Category Analysis
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Data Status -->
                <div class="bg-white/10 rounded-lg p-4">
                    <h4 class="text-white font-bold mb-2">üìà Current Data Status</h4>
                    <div id="dataStatus" class="grid md:grid-cols-3 gap-4 text-sm">
                        <!-- Data status will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-white">Final Rankings</h3>
                    <button onclick="announceWinner()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                        üèÜ Announce Winner
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table id="resultsTable" class="w-full text-white">
                        <thead>
                            <tr class="border-b border-white/20">
                                <th class="text-left py-3 px-4">Rank</th>
                                <th class="text-left py-3 px-4">Contestant</th>
                                <th class="text-left py-3 px-4">Total Score</th>
                                <th class="text-left py-3 px-4">Average</th>
                                <th class="text-left py-3 px-4">Category Averages</th>
                                <th class="text-left py-3 px-4">Details</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced cross-device session management
        const DEVICE_ID = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const SESSION_HEARTBEAT_INTERVAL = 5000; // 5 seconds
        const SESSION_TIMEOUT = 3600000; // 1 hour timeout (3600000 ms)
        const GLOBAL_SESSION_KEY = 'pageant_global_sessions';
        
        // Configuration - Now dynamically managed
        let CONFIG = {
            contestants: [
                'Contestant 1', 'Contestant 2', 'Contestant 3', 
                'Contestant 4', 'Contestant 5', 'Contestant 6'
            ],
            judges: [
                { id: 1, name: 'Judge 1' },
                { id: 2, name: 'Judge 2' },
                { id: 3, name: 'Judge 3' },
                { id: 4, name: 'Judge 4' }
            ],
            categories: {
                'Evening Gown': ['Elegance', 'Fit', 'Style', 'Confidence', 'Overall Presentation'],
                'Swimwear': ['Fitness', 'Confidence', 'Poise', 'Stage Presence', 'Overall Appeal'],
                'Talent': ['Skill Level', 'Creativity', 'Entertainment Value', 'Stage Presence', 'Originality'],
                'Interview': ['Articulation', 'Intelligence', 'Personality', 'Confidence', 'Relevance'],
                'National Costume': ['Creativity', 'Cultural Representation', 'Craftsmanship', 'Presentation', 'Authenticity']
            }
        };

        let currentJudge = 1;
        let currentPageType = null;
        let heartbeatInterval = null;
        let sessionMonitorInterval = null;

        // Cross-device session management functions
        function getGlobalSessions() {
            const sessions = localStorage.getItem(GLOBAL_SESSION_KEY);
            return sessions ? JSON.parse(sessions) : {};
        }

        function setGlobalSessions(sessions) {
            localStorage.setItem(GLOBAL_SESSION_KEY, JSON.stringify(sessions));
        }

        function cleanExpiredSessions() {
            const sessions = getGlobalSessions();
            const now = Date.now();
            let changed = false;
            
            Object.keys(sessions).forEach(sessionKey => {
                if (now - sessions[sessionKey].lastHeartbeat > SESSION_TIMEOUT) {
                    delete sessions[sessionKey];
                    changed = true;
                }
            });
            
            if (changed) {
                setGlobalSessions(sessions);
            }
        }

        function isPageLocked(pageType, judgeId = null) {
            cleanExpiredSessions();
            const sessions = getGlobalSessions();
            const sessionKey = pageType === 'admin' ? 'admin' : `judge_${judgeId}`;
            
            const session = sessions[sessionKey];
            if (!session) return false;
            
            // Check if it's locked by a different device
            return session.deviceId !== DEVICE_ID;
        }

        function lockPage(pageType, judgeId = null) {
            cleanExpiredSessions();
            const sessions = getGlobalSessions();
            const sessionKey = pageType === 'admin' ? 'admin' : `judge_${judgeId}`;
            
            // Double-check if someone else just locked it
            if (sessions[sessionKey] && sessions[sessionKey].deviceId !== DEVICE_ID) {
                return false;
            }
            
            // Lock the page for this device
            sessions[sessionKey] = {
                deviceId: DEVICE_ID,
                pageType: pageType,
                judgeId: judgeId,
                lastHeartbeat: Date.now(),
                userAgent: navigator.userAgent.substring(0, 50),
                timestamp: Date.now()
            };
            
            setGlobalSessions(sessions);
            
            // Start heartbeat to maintain the lock
            startHeartbeat(sessionKey);
            
            return true;
        }

        function unlockPage(pageType, judgeId = null) {
            const sessions = getGlobalSessions();
            const sessionKey = pageType === 'admin' ? 'admin' : `judge_${judgeId}`;
            
            // Only unlock if this is our session
            if (sessions[sessionKey] && sessions[sessionKey].deviceId === DEVICE_ID) {
                delete sessions[sessionKey];
                setGlobalSessions(sessions);
            }
            
            stopHeartbeat();
        }

        function forceUnlockPage(pageType, judgeId = null) {
            const sessions = getGlobalSessions();
            const sessionKey = pageType === 'admin' ? 'admin' : `judge_${judgeId}`;
            delete sessions[sessionKey];
            setGlobalSessions(sessions);
        }

        function startHeartbeat(sessionKey) {
            stopHeartbeat(); // Clear any existing heartbeat
            
            heartbeatInterval = setInterval(() => {
                const sessions = getGlobalSessions();
                if (sessions[sessionKey] && sessions[sessionKey].deviceId === DEVICE_ID) {
                    sessions[sessionKey].lastHeartbeat = Date.now();
                    setGlobalSessions(sessions);
                } else {
                    // Session was taken over by another device
                    stopHeartbeat();
                    showLockOverlay(currentPageType, currentJudge);
                }
            }, SESSION_HEARTBEAT_INTERVAL);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        function startSessionMonitor() {
            sessionMonitorInterval = setInterval(() => {
                cleanExpiredSessions();
                updateSessionStatus();
                
                // Check if our current session was taken over
                if (currentPageType && currentPageType !== 'home') {
                    const sessionKey = currentPageType === 'admin' ? 'admin' : `judge_${currentJudge}`;
                    const sessions = getGlobalSessions();
                    
                    if (sessions[sessionKey] && sessions[sessionKey].deviceId !== DEVICE_ID) {
                        // Our session was taken over
                        stopHeartbeat();
                        showLockOverlay(currentPageType, currentJudge);
                    }
                }
            }, 10000); // Check every 10 seconds
        }

        function forceUnlockAll() {
            if (confirm('Force unlock all sessions? This will kick out all active users.')) {
                // Clear all global sessions
                setGlobalSessions({});
                
                alert('All sessions have been forcefully unlocked.');
                updateSessionStatus();
            }
        }

        function showLockOverlay(pageType, judgeId = null) {
            const overlay = document.getElementById('lockOverlay');
            const message = document.getElementById('lockMessage');
            
            if (pageType === 'admin') {
                message.textContent = 'The admin panel is currently being used by another user. Please wait for them to finish or ask an administrator to force unlock.';
            } else {
                const judge = CONFIG.judges.find(j => j.id === judgeId);
                message.textContent = `${judge.name}'s scoring panel is currently being used by another user. Please wait for them to finish.`;
            }
            
            overlay.classList.remove('hidden');
        }

        function hideLockOverlay() {
            document.getElementById('lockOverlay').classList.add('hidden');
        }

        function checkLockStatus() {
            hideLockOverlay();
            updateSessionStatus();
        }

        function viewActiveSessions() {
            cleanExpiredSessions();
            const sessions = getGlobalSessions();
            let sessionInfo = 'Active Sessions:\n\n';
            
            // Check admin session
            if (sessions.admin) {
                const timeAgo = Math.floor((Date.now() - sessions.admin.lastHeartbeat) / 1000 / 60);
                const isOurs = sessions.admin.deviceId === DEVICE_ID;
                sessionInfo += `Admin Panel: ${isOurs ? 'Your device' : 'Another device'} (${timeAgo}m ago)\n`;
            }
            
            // Check judge sessions
            CONFIG.judges.forEach(judge => {
                const sessionKey = `judge_${judge.id}`;
                if (sessions[sessionKey]) {
                    const timeAgo = Math.floor((Date.now() - sessions[sessionKey].lastHeartbeat) / 1000 / 60);
                    const isOurs = sessions[sessionKey].deviceId === DEVICE_ID;
                    sessionInfo += `${judge.name}: ${isOurs ? 'Your device' : 'Another device'} (${timeAgo}m ago)\n`;
                }
            });
            
            if (Object.keys(sessions).length === 0) {
                sessionInfo += 'No active sessions found.';
            }
            
            alert(sessionInfo);
        }

        function updateSessionStatus() {
            cleanExpiredSessions();
            const sessions = getGlobalSessions();
            const statusContainer = document.getElementById('sessionStatus');
            const indicator = document.getElementById('sessionIndicator');
            
            if (!statusContainer) return;
            
            statusContainer.innerHTML = '';
            indicator.textContent = `Device: ${DEVICE_ID.substring(0, 12)}...`;
            
            // Admin status
            const adminDiv = document.createElement('div');
            if (sessions.admin) {
                const isOurs = sessions.admin.deviceId === DEVICE_ID;
                const timeAgo = Math.floor((Date.now() - sessions.admin.lastHeartbeat) / 1000 / 60);
                adminDiv.innerHTML = `
                    <div class="flex items-center justify-between p-2 rounded ${isOurs ? 'bg-green-600/20' : 'bg-red-600/20'}">
                        <span class="text-white">Admin Panel</span>
                        <span class="text-xs ${isOurs ? 'text-green-300' : 'text-red-300'}">${isOurs ? 'Your device' : `Locked (${timeAgo}m ago)`}</span>
                    </div>
                `;
            } else {
                adminDiv.innerHTML = `
                    <div class="flex items-center justify-between p-2 rounded bg-gray-600/20">
                        <span class="text-white">Admin Panel</span>
                        <span class="text-xs text-gray-300">Available</span>
                    </div>
                `;
            }
            statusContainer.appendChild(adminDiv);
            
            // Judge statuses
            const judgeDiv = document.createElement('div');
            judgeDiv.innerHTML = '<div class="space-y-1">';
            CONFIG.judges.forEach(judge => {
                const sessionKey = `judge_${judge.id}`;
                if (sessions[sessionKey]) {
                    const isOurs = sessions[sessionKey].deviceId === DEVICE_ID;
                    const timeAgo = Math.floor((Date.now() - sessions[sessionKey].lastHeartbeat) / 1000 / 60);
                    judgeDiv.innerHTML += `
                        <div class="flex items-center justify-between p-2 rounded ${isOurs ? 'bg-green-600/20' : 'bg-red-600/20'}">
                            <span class="text-white">${judge.name}</span>
                            <span class="text-xs ${isOurs ? 'text-green-300' : 'text-red-300'}">${isOurs ? 'Your device' : `Locked (${timeAgo}m ago)`}</span>
                        </div>
                    `;
                } else {
                    judgeDiv.innerHTML += `
                        <div class="flex items-center justify-between p-2 rounded bg-gray-600/20">
                            <span class="text-white">${judge.name}</span>
                            <span class="text-xs text-gray-300">Available</span>
                        </div>
                    `;
                }
            });
            judgeDiv.innerHTML += '</div>';
            statusContainer.appendChild(judgeDiv);
        }

        // Load configuration from localStorage or use defaults
        function loadConfig() {
            const savedConfig = localStorage.getItem('pageant_config');
            if (savedConfig) {
                CONFIG = { ...CONFIG, ...JSON.parse(savedConfig) };
            }
        }

        // Save configuration to localStorage
        function saveConfig() {
            localStorage.setItem('pageant_config', JSON.stringify({
                contestants: CONFIG.contestants,
                judges: CONFIG.judges
            }));
        }

        // Initialize the application
        function initApp() {
            loadConfig();
            updateJudgeButtons();
            populateContestantSelect();
            updateJudgesList();
            updateContestantsList();
            updateSessionStatus();
            showPage('home');
            
            // Start session monitoring
            startSessionMonitor();
        }

        // Update judge buttons on home page
        function updateJudgeButtons() {
            const container = document.getElementById('judgeButtons');
            container.innerHTML = '';
            
            CONFIG.judges.forEach(judge => {
                const button = document.createElement('button');
                button.onclick = () => showJudgePage(judge.id);
                button.className = 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors pulse-hover';
                button.textContent = judge.name;
                container.appendChild(button);
            });
        }

        // Add new judge
        function addJudge() {
            const nameInput = document.getElementById('judgeNameInput');
            const judgeName = nameInput.value.trim() || `Judge ${CONFIG.judges.length + 1}`;
            const newId = Math.max(...CONFIG.judges.map(j => j.id), 0) + 1;
            
            CONFIG.judges.push({ id: newId, name: judgeName });
            nameInput.value = '';
            
            saveConfig();
            updateJudgeButtons();
            updateJudgesList();
            updateSessionStatus();
        }

        // Remove judge
        function removeJudge(judgeId) {
            if (CONFIG.judges.length <= 1) {
                alert('You must have at least one judge!');
                return;
            }
            
            if (confirm('Are you sure you want to remove this judge? All their scores will be deleted.')) {
                // Force unlock the judge's session
                forceUnlockPage('judge', judgeId);
                
                // Remove judge from config
                CONFIG.judges = CONFIG.judges.filter(j => j.id !== judgeId);
                
                // Clear all scores for this judge
                CONFIG.contestants.forEach(contestant => {
                    const storageKey = `judge${judgeId}_${contestant}`;
                    localStorage.removeItem(storageKey);
                });
                
                saveConfig();
                updateJudgeButtons();
                updateJudgesList();
                updateSessionStatus();
                calculateResults();
            }
        }

        // Update judges list in admin
        function updateJudgesList() {
            const container = document.getElementById('judgesList');
            container.innerHTML = '';
            
            CONFIG.judges.forEach(judge => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-white/10 rounded px-3 py-2';
                div.innerHTML = `
                    <span class="text-white">${judge.name}</span>
                    <button onclick="removeJudge(${judge.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm transition-colors">Remove</button>
                `;
                container.appendChild(div);
            });
            
            // Also update export buttons when judges list changes
            updateJudgeExportButtons();
        }

        // Add new contestant
        function addContestant() {
            const nameInput = document.getElementById('contestantNameInput');
            const contestantName = nameInput.value.trim();
            
            if (!contestantName) {
                alert('Please enter a contestant name!');
                return;
            }
            
            if (CONFIG.contestants.includes(contestantName)) {
                alert('This contestant already exists!');
                return;
            }
            
            CONFIG.contestants.push(contestantName);
            nameInput.value = '';
            
            saveConfig();
            populateContestantSelect();
            updateContestantsList();
        }

        // Remove contestant
        function removeContestant(contestantName) {
            if (CONFIG.contestants.length <= 1) {
                alert('You must have at least one contestant!');
                return;
            }
            
            if (confirm('Are you sure you want to remove this contestant? All their scores will be deleted.')) {
                // Remove contestant from config
                CONFIG.contestants = CONFIG.contestants.filter(c => c !== contestantName);
                
                // Clear all scores for this contestant
                CONFIG.judges.forEach(judge => {
                    const storageKey = `judge${judge.id}_${contestantName}`;
                    localStorage.removeItem(storageKey);
                });
                
                saveConfig();
                populateContestantSelect();
                updateContestantsList();
                calculateResults();
            }
        }

        // Update contestants list in admin
        function updateContestantsList() {
            const container = document.getElementById('contestantsList');
            container.innerHTML = '';
            
            CONFIG.contestants.forEach(contestant => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-white/10 rounded px-3 py-2';
                div.innerHTML = `
                    <span class="text-white">${contestant}</span>
                    <button onclick="removeContestant('${contestant}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm transition-colors">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        // Show specific page
        function showPage(pageType) {
            // Unlock current page when navigating away
            if (currentPageType === 'admin') {
                unlockPage('admin');
            } else if (currentPageType === 'judge' && currentJudge) {
                unlockPage('judge', currentJudge);
            }
            
            hideLockOverlay();
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            
            if (pageType === 'home') {
                document.getElementById('homePage').classList.remove('hidden');
                currentPageType = 'home';
                currentJudge = null;
                updateSessionStatus();
            } else if (pageType === 'admin') {
                showAdminPage();
            }
        }

        // Show admin page directly
        function showAdminPage() {
            if (isPageLocked('admin')) {
                showLockOverlay('admin');
                return;
            }
            
            if (!lockPage('admin')) {
                showLockOverlay('admin');
                return;
            }
            
            hideLockOverlay();
            currentPageType = 'admin';
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById('adminPage').classList.remove('hidden');
            updateJudgesList();
            updateContestantsList();
            updateJudgeExportButtons();
            calculateResults();
        }

        // Update judge export buttons in admin
        function updateJudgeExportButtons() {
            const container = document.getElementById('judgeExportButtons');
            if (!container) return;
            
            container.innerHTML = '';
            
            CONFIG.judges.forEach(judge => {
                const button = document.createElement('button');
                button.onclick = () => exportJudgeScoresheet(judge.id);
                button.className = 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm';
                button.innerHTML = `üìä ${judge.name}`;
                container.appendChild(button);
            });
        }

        // Export judge scoresheet from admin (modified to accept judgeId parameter)
        function exportJudgeScoresheet(judgeId = null) {
            const targetJudgeId = judgeId || currentJudge;
            const judge = CONFIG.judges.find(j => j.id === targetJudgeId);
            
            if (!judge) {
                alert('Judge not found!');
                return;
            }
            
            let csv = `${judge.name} - Complete Scoresheet\n\n`;
            
            // Header row
            csv += 'Contestant,';
            Object.keys(CONFIG.categories).forEach(category => {
                CONFIG.categories[category].forEach(subcategory => {
                    csv += `${category} - ${subcategory},`;
                });
                csv += `${category} Total,`;
            });
            csv += 'Grand Total\n';

            // Data rows
            CONFIG.contestants.forEach(contestant => {
                csv += `${contestant},`;
                let grandTotal = 0;
                
                const storageKey = `judge${targetJudgeId}_${contestant}`;
                const savedScores = localStorage.getItem(storageKey);
                
                if (savedScores) {
                    const scores = JSON.parse(savedScores);
                    
                    Object.entries(CONFIG.categories).forEach(([category, subcategories]) => {
                        let categoryTotal = 0;
                        
                        subcategories.forEach(subcategory => {
                            const score = scores[category] && scores[category][subcategory] ? scores[category][subcategory] : 0;
                            csv += `${score.toFixed(1)},`;
                            categoryTotal += score;
                        });
                        
                        csv += `${categoryTotal.toFixed(1)},`;
                        grandTotal += categoryTotal;
                    });
                } else {
                    // No scores found, fill with zeros
                    Object.keys(CONFIG.categories).forEach(category => {
                        CONFIG.categories[category].forEach(() => {
                            csv += '0.0,';
                        });
                        csv += '0.0,';
                    });
                }
                
                csv += `${grandTotal.toFixed(1)}\n`;
            });

            // Add category summary
            csv += '\n\nCategory Summary:\n';
            Object.keys(CONFIG.categories).forEach(category => {
                csv += `\n${category}:\n`;
                CONFIG.contestants.forEach(contestant => {
                    const storageKey = `judge${targetJudgeId}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    if (savedScores) {
                        const scores = JSON.parse(savedScores);
                        if (scores[category]) {
                            const categoryTotal = Object.values(scores[category]).reduce((sum, score) => sum + score, 0);
                            csv += `${contestant}: ${categoryTotal.toFixed(1)}\n`;
                        } else {
                            csv += `${contestant}: 0.0\n`;
                        }
                    } else {
                        csv += `${contestant}: 0.0\n`;
                    }
                });
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${judge.name.replace(/\s+/g, '_')}_scoresheet.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert(`üìä Scoresheet exported successfully for ${judge.name}!`);
        }

        // Show judge scoring page
        function showJudgePage(judgeId) {
            if (isPageLocked('judge', judgeId)) {
                showLockOverlay('judge', judgeId);
                return;
            }
            
            if (!lockPage('judge', judgeId)) {
                showLockOverlay('judge', judgeId);
                return;
            }
            
            hideLockOverlay();
            currentPageType = 'judge';
            currentJudge = judgeId;
            const judge = CONFIG.judges.find(j => j.id === judgeId);
            document.getElementById('judgeTitle').textContent = `${judge.name} - Scoring Panel`;
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById('judgePage').classList.remove('hidden');
            generateScoringForm();
            loadExistingScores();
            
            // Show session warning
            document.getElementById('sessionWarning').classList.remove('hidden');
            updateTimeRemaining();
        }

        function updateTimeRemaining() {
            const timeSpan = document.getElementById('timeRemaining');
            if (timeSpan && currentPageType === 'judge' && currentJudge) {
                const sessions = getGlobalSessions();
                const sessionKey = `judge_${currentJudge}`;
                if (sessions[sessionKey] && sessions[sessionKey].deviceId === DEVICE_ID) {
                    const millisecondsLeft = SESSION_TIMEOUT - (Date.now() - sessions[sessionKey].lastHeartbeat);
                    const minutesLeft = Math.floor(millisecondsLeft / 1000 / 60);
                    timeSpan.textContent = Math.max(0, minutesLeft);
                }
            }
        }

        // Populate contestant dropdown (kept for compatibility)
        function populateContestantSelect() {
            // This function is kept for compatibility but no longer needed
            // since we now show all contestants at once
        }

        // Generate scoring form for current judge - now shows all contestants
        function generateScoringForm() {
            const grid = document.getElementById('contestantsGrid');
            grid.innerHTML = '';

            CONFIG.contestants.forEach(contestant => {
                const contestantCard = document.createElement('div');
                contestantCard.className = 'bg-white/10 backdrop-blur-md rounded-xl p-8 card-hover';
                
                let categoriesHTML = '';
                Object.entries(CONFIG.categories).forEach(([category, subcategories]) => {
                    let subcategoryInputs = '';
                    subcategories.forEach(subcategory => {
                        subcategoryInputs += `
                            <div class="mb-3">
                                <label class="block text-white text-xs font-medium mb-1">${subcategory}</label>
                                <input type="number" 
                                       min="0" max="10" step="0.1"
                                       class="w-full bg-white/20 text-white rounded-lg px-3 py-2 border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm"
                                       data-contestant="${contestant}"
                                       data-category="${category}" 
                                       data-subcategory="${subcategory}"
                                       placeholder="0-10">
                            </div>
                        `;
                    });

                    categoriesHTML += `
                        <div class="bg-white/10 rounded-lg p-4 mb-4">
                            <h4 class="text-lg font-bold text-white mb-3 border-b border-white/20 pb-2">${category}</h4>
                            <div class="grid grid-cols-1 gap-2">
                                ${subcategoryInputs}
                            </div>
                            <div class="mt-3 p-2 bg-white/10 rounded-lg">
                                <span class="text-white font-medium text-sm">Category Total: </span>
                                <span id="total-${contestant.replace(/\s+/g, '')}-${category.replace(/\s+/g, '')}" class="text-purple-300 font-bold">0.0</span>
                            </div>
                        </div>
                    `;
                });

                contestantCard.innerHTML = `
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-white bg-purple-600/30 rounded-lg py-3 px-4 border-2 border-purple-400">${contestant}</h3>
                        <div class="mt-2 p-2 bg-white/10 rounded-lg">
                            <span class="text-white font-medium">Grand Total: </span>
                            <span id="grandtotal-${contestant.replace(/\s+/g, '')}" class="text-yellow-300 font-bold text-lg">0.0</span>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${categoriesHTML}
                    </div>
                `;

                grid.appendChild(contestantCard);
            });

            // Add event listeners for real-time calculation
            grid.addEventListener('input', calculateAllTotals);
            
            // Load existing scores for all contestants
            loadAllExistingScores();
        }

        // Calculate all totals in real-time for all contestants
        function calculateAllTotals() {
            CONFIG.contestants.forEach(contestant => {
                let grandTotal = 0;
                
                Object.keys(CONFIG.categories).forEach(category => {
                    const inputs = document.querySelectorAll(`input[data-contestant="${contestant}"][data-category="${category}"]`);
                    let categoryTotal = 0;
                    inputs.forEach(input => {
                        categoryTotal += parseFloat(input.value) || 0;
                    });
                    
                    const totalElement = document.getElementById(`total-${contestant.replace(/\s+/g, '')}-${category.replace(/\s+/g, '')}`);
                    if (totalElement) {
                        totalElement.textContent = categoryTotal.toFixed(1);
                    }
                    
                    grandTotal += categoryTotal;
                });
                
                const grandTotalElement = document.getElementById(`grandtotal-${contestant.replace(/\s+/g, '')}`);
                if (grandTotalElement) {
                    grandTotalElement.textContent = grandTotal.toFixed(1);
                }
            });
        }

        // Save all scores to local storage
        function saveAllScores() {
            let savedCount = 0;
            
            CONFIG.contestants.forEach(contestant => {
                const scores = {};
                Object.entries(CONFIG.categories).forEach(([category, subcategories]) => {
                    scores[category] = {};
                    subcategories.forEach(subcategory => {
                        const input = document.querySelector(`input[data-contestant="${contestant}"][data-category="${category}"][data-subcategory="${subcategory}"]`);
                        scores[category][subcategory] = parseFloat(input.value) || 0;
                    });
                });

                // Save to local storage
                const storageKey = `judge${currentJudge}_${contestant}`;
                localStorage.setItem(storageKey, JSON.stringify(scores));
                savedCount++;
            });
            
            alert(`‚úÖ All scores saved successfully for ${savedCount} contestants!`);
        }

        // Load existing scores for all contestants
        function loadAllExistingScores() {
            CONFIG.contestants.forEach(contestant => {
                const storageKey = `judge${currentJudge}_${contestant}`;
                const savedScores = localStorage.getItem(storageKey);
                
                if (savedScores) {
                    const scores = JSON.parse(savedScores);
                    Object.entries(scores).forEach(([category, subcategoryScores]) => {
                        Object.entries(subcategoryScores).forEach(([subcategory, score]) => {
                            const input = document.querySelector(`input[data-contestant="${contestant}"][data-category="${category}"][data-subcategory="${subcategory}"]`);
                            if (input) {
                                input.value = score;
                            }
                        });
                    });
                }
            });
            
            // Calculate all totals after loading
            calculateAllTotals();
        }

        // Export individual judge scoresheet
        function exportJudgeScoresheet() {
            const judge = CONFIG.judges.find(j => j.id === currentJudge);
            let csv = `${judge.name} - Complete Scoresheet\n\n`;
            
            // Header row
            csv += 'Contestant,';
            Object.keys(CONFIG.categories).forEach(category => {
                CONFIG.categories[category].forEach(subcategory => {
                    csv += `${category} - ${subcategory},`;
                });
                csv += `${category} Total,`;
            });
            csv += 'Grand Total\n';

            // Data rows
            CONFIG.contestants.forEach(contestant => {
                csv += `${contestant},`;
                let grandTotal = 0;
                
                Object.entries(CONFIG.categories).forEach(([category, subcategories]) => {
                    let categoryTotal = 0;
                    
                    subcategories.forEach(subcategory => {
                        const input = document.querySelector(`input[data-contestant="${contestant}"][data-category="${category}"][data-subcategory="${subcategory}"]`);
                        const score = parseFloat(input?.value) || 0;
                        csv += `${score.toFixed(1)},`;
                        categoryTotal += score;
                    });
                    
                    csv += `${categoryTotal.toFixed(1)},`;
                    grandTotal += categoryTotal;
                });
                
                csv += `${grandTotal.toFixed(1)}\n`;
            });

            // Add category summary
            csv += '\n\nCategory Summary:\n';
            Object.keys(CONFIG.categories).forEach(category => {
                csv += `\n${category}:\n`;
                CONFIG.contestants.forEach(contestant => {
                    const storageKey = `judge${currentJudge}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    if (savedScores) {
                        const scores = JSON.parse(savedScores);
                        if (scores[category]) {
                            const categoryTotal = Object.values(scores[category]).reduce((sum, score) => sum + score, 0);
                            const categoryAverage = Object.keys(scores[category]).length > 0 ? categoryTotal / Object.keys(scores[category]).length : 0;
                            csv += `${contestant}: ${categoryAverage.toFixed(1)}\n`;
                        }
                    }
                });
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${judge.name.replace(/\s+/g, '_')}_scoresheet.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert(`üìä Scoresheet exported successfully for ${judge.name}!`);
        }

        // Calculate final results
        function calculateResults() {
            const results = [];

            CONFIG.contestants.forEach(contestant => {
                let totalScore = 0;
                let judgeCount = 0;
                const categoryAverages = {};

                // Initialize category averages
                Object.keys(CONFIG.categories).forEach(category => {
                    categoryAverages[category] = 0;
                });

                // Collect scores from all judges
                CONFIG.judges.forEach(judge => {
                    const storageKey = `judge${judge.id}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    
                    if (savedScores) {
                        judgeCount++;
                        const scores = JSON.parse(savedScores);
                        Object.entries(scores).forEach(([category, subcategoryScores]) => {
                            const categoryTotal = Object.values(subcategoryScores).reduce((sum, score) => sum + score, 0);
                            const categoryAverage = Object.keys(subcategoryScores).length > 0 ? categoryTotal / Object.keys(subcategoryScores).length : 0;
                            categoryAverages[category] += categoryAverage;
                            totalScore += categoryAverage;
                        });
                    }
                });

                if (judgeCount > 0) {
                    // Calculate final category averages across all judges
                    Object.keys(categoryAverages).forEach(category => {
                        categoryAverages[category] = categoryAverages[category] / judgeCount;
                    });

                    results.push({
                        contestant,
                        totalScore,
                        averageScore: totalScore / judgeCount,
                        judgeCount,
                        categoryAverages
                    });
                }
            });

            // Sort by total score (descending)
            results.sort((a, b) => b.totalScore - a.totalScore);

            displayResults(results);
        }

        // Display results in the admin table
        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            results.forEach((result, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-white/10 hover:bg-white/5 transition-colors';
                
                // Add special styling for top 3
                let rankDisplay = index + 1;
                let rankClass = '';
                if (index === 0) {
                    rankClass = 'text-yellow-400 font-bold'; // Gold
                    rankDisplay = 'ü•á 1st';
                } else if (index === 1) {
                    rankClass = 'text-gray-300 font-bold'; // Silver
                    rankDisplay = 'ü•à 2nd';
                } else if (index === 2) {
                    rankClass = 'text-yellow-600 font-bold'; // Bronze
                    rankDisplay = 'ü•â 3rd';
                }

                // Create category averages display
                let categoryAveragesHTML = '<div class="text-xs space-y-1">';
                Object.keys(CONFIG.categories).forEach(category => {
                    if (result.categoryAverages && result.categoryAverages[category]) {
                        categoryAveragesHTML += `<div><span class="text-white/60">${category}:</span> <span class="text-white">${result.categoryAverages[category].toFixed(1)}</span></div>`;
                    }
                });
                categoryAveragesHTML += '</div>';

                row.innerHTML = `
                    <td class="py-3 px-4 ${rankClass}">${rankDisplay}</td>
                    <td class="py-3 px-4 font-medium">${result.contestant}</td>
                    <td class="py-3 px-4 font-bold text-purple-400">${result.totalScore.toFixed(1)}</td>
                    <td class="py-3 px-4">${result.averageScore.toFixed(1)}</td>
                    <td class="py-3 px-4">${categoryAveragesHTML}</td>
                    <td class="py-3 px-4">
                        <button onclick="showDetails('${result.contestant}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            View Details
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update data status
            updateDataStatus();
        }

        // Announce winner with celebration
        function announceWinner() {
            calculateResults();
            
            // Get current results
            const results = [];
            CONFIG.contestants.forEach(contestant => {
                let totalScore = 0;
                let judgeCount = 0;
                const categoryAverages = {};

                Object.keys(CONFIG.categories).forEach(category => {
                    categoryAverages[category] = 0;
                });

                CONFIG.judges.forEach(judge => {
                    const storageKey = `judge${judge.id}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    
                    if (savedScores) {
                        judgeCount++;
                        const scores = JSON.parse(savedScores);
                        Object.entries(scores).forEach(([category, subcategoryScores]) => {
                            const categoryTotal = Object.values(subcategoryScores).reduce((sum, score) => sum + score, 0);
                            const categoryAverage = Object.keys(subcategoryScores).length > 0 ? categoryTotal / Object.keys(subcategoryScores).length : 0;
                            categoryAverages[category] += categoryAverage;
                            totalScore += categoryAverage;
                        });
                    }
                });

                if (judgeCount > 0) {
                    // Calculate final category averages across all judges
                    Object.keys(categoryAverages).forEach(category => {
                        categoryAverages[category] = categoryAverages[category] / judgeCount;
                    });

                    results.push({
                        contestant,
                        totalScore,
                        averageScore: totalScore / judgeCount,
                        judgeCount,
                        categoryAverages
                    });
                }
            });

            results.sort((a, b) => b.totalScore - a.totalScore);

            if (results.length === 0) {
                alert('No scores available to announce a winner!');
                return;
            }

            // Show winner announcement
            const winnerAnnouncement = document.getElementById('winnerAnnouncement');
            const winnerDetails = document.getElementById('winnerDetails');
            const topThree = document.getElementById('topThree');

            const winner = results[0];
            winnerDetails.innerHTML = `
                <div class="mb-4">
                    <div class="text-5xl font-bold text-yellow-400 mb-2">${winner.contestant}</div>
                    <div class="text-xl text-white/90">Final Score: ${winner.totalScore.toFixed(1)} (Average: ${winner.averageScore.toFixed(1)})</div>
                </div>
            `;

            // Show top 3
            topThree.innerHTML = '';
            const podiumPositions = ['ü•á WINNER', 'ü•à RUNNER-UP', 'ü•â SECOND RUNNER-UP'];
            const podiumColors = ['text-yellow-400', 'text-gray-300', 'text-yellow-600'];
            
            results.slice(0, 3).forEach((result, index) => {
                const podiumCard = document.createElement('div');
                podiumCard.className = `bg-white/10 rounded-lg p-6 text-center ${index === 0 ? 'transform scale-110 border-2 border-yellow-400' : ''}`;
                podiumCard.innerHTML = `
                    <div class="${podiumColors[index]} text-2xl font-bold mb-2">${podiumPositions[index]}</div>
                    <div class="text-white text-xl font-bold mb-2">${result.contestant}</div>
                    <div class="text-white/80 text-lg">Score: ${result.totalScore.toFixed(1)}</div>
                    <div class="text-white/60 text-sm">Average: ${result.averageScore.toFixed(1)}</div>
                `;
                topThree.appendChild(podiumCard);
            });

            winnerAnnouncement.classList.remove('hidden');
            winnerAnnouncement.scrollIntoView({ behavior: 'smooth' });

            // Celebration alert
            setTimeout(() => {
                alert(`üéâ CONGRATULATIONS TO ${winner.contestant}! üéâ\n\nFinal Score: ${winner.totalScore.toFixed(1)}\nAverage Score: ${winner.averageScore.toFixed(1)}\n\nThank you to all contestants and judges!`);
            }, 1000);
        }

        // Import CSV data
        function importCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file to import.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 3) {
                        alert('Invalid CSV format. File appears to be too short.');
                        return;
                    }

                    // Try to detect if this is a judge scoresheet
                    const firstLine = lines[0];
                    let judgeId = null;
                    let judgeName = '';

                    // Look for judge name in first line
                    const judgeMatch = firstLine.match(/^(.+?)\s*-\s*Complete Scoresheet/);
                    if (judgeMatch) {
                        judgeName = judgeMatch[1].trim();
                        
                        // Find or create judge
                        let judge = CONFIG.judges.find(j => j.name === judgeName);
                        if (!judge) {
                            // Create new judge
                            const newId = Math.max(...CONFIG.judges.map(j => j.id), 0) + 1;
                            judge = { id: newId, name: judgeName };
                            CONFIG.judges.push(judge);
                            saveConfig();
                            updateJudgeButtons();
                            updateJudgesList();
                        }
                        judgeId = judge.id;
                    } else {
                        alert('Could not identify judge from CSV file. Please ensure the file starts with "Judge Name - Complete Scoresheet"');
                        return;
                    }

                    // Find the header row (should contain "Contestant")
                    let headerRowIndex = -1;
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i].includes('Contestant') && lines[i].includes('Grand Total')) {
                            headerRowIndex = i;
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        alert('Could not find header row in CSV file.');
                        return;
                    }

                    const headers = lines[headerRowIndex].split(',').map(h => h.trim());
                    let importedCount = 0;

                    // Process data rows
                    for (let i = headerRowIndex + 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line || line.startsWith('Category Summary')) break;

                        const values = line.split(',').map(v => v.trim());
                        const contestant = values[0];

                        if (!contestant || contestant === '') continue;

                        // Add contestant if not exists
                        if (!CONFIG.contestants.includes(contestant)) {
                            CONFIG.contestants.push(contestant);
                        }

                        // Parse scores
                        const scores = {};
                        let valueIndex = 1;

                        Object.entries(CONFIG.categories).forEach(([category, subcategories]) => {
                            scores[category] = {};
                            subcategories.forEach(subcategory => {
                                const score = parseFloat(values[valueIndex]) || 0;
                                scores[category][subcategory] = score;
                                valueIndex++;
                            });
                            valueIndex++; // Skip category total column
                        });

                        // Save scores
                        const storageKey = `judge${judgeId}_${contestant}`;
                        localStorage.setItem(storageKey, JSON.stringify(scores));
                        importedCount++;
                    }

                    saveConfig();
                    updateContestantsList();
                    calculateResults();
                    
                    alert(`‚úÖ Successfully imported scores for ${importedCount} contestants from ${judgeName}'s scoresheet!`);
                    fileInput.value = ''; // Clear file input

                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing CSV file. Please check the file format and try again.');
                }
            };

            reader.readAsText(file);
        }

        // Export master scoresheet with all data
        function exportMasterScoresheet() {
            let csv = 'MASTER SCORESHEET - ALL JUDGES AND CONTESTANTS\n\n';
            
            // Create comprehensive header
            csv += 'Contestant,';
            CONFIG.judges.forEach(judge => {
                Object.keys(CONFIG.categories).forEach(category => {
                    CONFIG.categories[category].forEach(subcategory => {
                        csv += `${judge.name} - ${category} - ${subcategory},`;
                    });
                    csv += `${judge.name} - ${category} Average,`;
                });
                csv += `${judge.name} - Grand Total,`;
            });
            csv += 'Final Average,Final Total\n';

            // Data rows
            CONFIG.contestants.forEach(contestant => {
                csv += `${contestant},`;
                let finalTotal = 0;
                let judgeCount = 0;

                CONFIG.judges.forEach(judge => {
                    const storageKey = `judge${judge.id}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    let judgeTotal = 0;

                    if (savedScores) {
                        judgeCount++;
                        const scores = JSON.parse(savedScores);
                        
                        Object.entries(CONFIG.categories).forEach(([category, subcategories]) => {
                            let categoryTotal = 0;
                            subcategories.forEach(subcategory => {
                                const score = scores[category] && scores[category][subcategory] ? scores[category][subcategory] : 0;
                                csv += `${score.toFixed(1)},`;
                                categoryTotal += score;
                            });
                            const categoryAverage = subcategories.length > 0 ? categoryTotal / subcategories.length : 0;
                            csv += `${categoryAverage.toFixed(1)},`;
                            judgeTotal += categoryAverage;
                        });
                    } else {
                        // No scores, fill with zeros
                        Object.keys(CONFIG.categories).forEach(category => {
                            CONFIG.categories[category].forEach(() => {
                                csv += '0.0,';
                            });
                            csv += '0.0,';
                        });
                    }
                    
                    csv += `${judgeTotal.toFixed(1)},`;
                    finalTotal += judgeTotal;
                });

                const finalAverage = judgeCount > 0 ? finalTotal / judgeCount : 0;
                csv += `${finalAverage.toFixed(1)},${finalTotal.toFixed(1)}\n`;
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'master_scoresheet_all_data.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('üìã Master scoresheet exported successfully!');
        }

        // Export final results summary
        function exportFinalResults() {
            calculateResults();
            
            const results = [];
            CONFIG.contestants.forEach(contestant => {
                let totalScore = 0;
                let judgeCount = 0;
                const categoryAverages = {};

                Object.keys(CONFIG.categories).forEach(category => {
                    categoryAverages[category] = 0;
                });

                CONFIG.judges.forEach(judge => {
                    const storageKey = `judge${judge.id}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    
                    if (savedScores) {
                        judgeCount++;
                        const scores = JSON.parse(savedScores);
                        Object.entries(scores).forEach(([category, subcategoryScores]) => {
                            const categoryTotal = Object.values(subcategoryScores).reduce((sum, score) => sum + score, 0);
                            const categoryAverage = Object.keys(subcategoryScores).length > 0 ? categoryTotal / Object.keys(subcategoryScores).length : 0;
                            categoryAverages[category] += categoryAverage;
                            totalScore += categoryAverage;
                        });
                    }
                });

                if (judgeCount > 0) {
                    Object.keys(categoryAverages).forEach(category => {
                        categoryAverages[category] = categoryAverages[category] / judgeCount;
                    });

                    results.push({
                        contestant,
                        totalScore,
                        averageScore: totalScore / judgeCount,
                        categoryAverages
                    });
                }
            });

            results.sort((a, b) => b.totalScore - a.totalScore);

            let csv = 'FINAL RESULTS SUMMARY\n\n';
            csv += 'Rank,Contestant,Total Score,Average Score,';
            Object.keys(CONFIG.categories).forEach(category => {
                csv += `${category} Average,`;
            });
            csv += '\n';

            results.forEach((result, index) => {
                const rank = index + 1;
                let rankDisplay = rank;
                if (rank === 1) rankDisplay = 'ü•á WINNER';
                else if (rank === 2) rankDisplay = 'ü•à RUNNER-UP';
                else if (rank === 3) rankDisplay = 'ü•â SECOND RUNNER-UP';

                csv += `${rankDisplay},${result.contestant},${result.totalScore.toFixed(1)},${result.averageScore.toFixed(1)},`;
                Object.keys(CONFIG.categories).forEach(category => {
                    csv += `${result.categoryAverages[category].toFixed(1)},`;
                });
                csv += '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'final_results_summary.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('üèÜ Final results summary exported successfully!');
        }

        // Export category breakdown analysis
        function exportCategoryBreakdown() {
            let csv = 'CATEGORY BREAKDOWN ANALYSIS\n\n';
            
            Object.keys(CONFIG.categories).forEach(category => {
                csv += `\n${category.toUpperCase()} CATEGORY:\n`;
                csv += 'Contestant,';
                CONFIG.judges.forEach(judge => {
                    csv += `${judge.name},`;
                });
                csv += 'Average\n';

                CONFIG.contestants.forEach(contestant => {
                    csv += `${contestant},`;
                    let categorySum = 0;
                    let judgeCount = 0;

                    CONFIG.judges.forEach(judge => {
                        const storageKey = `judge${judge.id}_${contestant}`;
                        const savedScores = localStorage.getItem(storageKey);
                        
                        if (savedScores) {
                            const scores = JSON.parse(savedScores);
                            if (scores[category]) {
                                const categoryTotal = Object.values(scores[category]).reduce((sum, score) => sum + score, 0);
                                const categoryAverage = Object.keys(scores[category]).length > 0 ? categoryTotal / Object.keys(scores[category]).length : 0;
                                csv += `${categoryAverage.toFixed(1)},`;
                                categorySum += categoryAverage;
                                judgeCount++;
                            } else {
                                csv += '0.0,';
                            }
                        } else {
                            csv += '0.0,';
                        }
                    });

                    const finalAverage = judgeCount > 0 ? categorySum / judgeCount : 0;
                    csv += `${finalAverage.toFixed(1)}\n`;
                });
                csv += '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'category_breakdown_analysis.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('üìä Category breakdown analysis exported successfully!');
        }

        // Update data status display
        function updateDataStatus() {
            const statusContainer = document.getElementById('dataStatus');
            if (!statusContainer) return;

            let totalScores = 0;
            let completedJudges = 0;
            let completedContestants = 0;

            // Count completed scores
            CONFIG.judges.forEach(judge => {
                let judgeHasScores = false;
                CONFIG.contestants.forEach(contestant => {
                    const storageKey = `judge${judge.id}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    if (savedScores) {
                        totalScores++;
                        judgeHasScores = true;
                    }
                });
                if (judgeHasScores) completedJudges++;
            });

            // Count contestants with at least one score
            CONFIG.contestants.forEach(contestant => {
                let contestantHasScores = false;
                CONFIG.judges.forEach(judge => {
                    const storageKey = `judge${judge.id}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    if (savedScores) {
                        contestantHasScores = true;
                    }
                });
                if (contestantHasScores) completedContestants++;
            });

            const totalPossible = CONFIG.judges.length * CONFIG.contestants.length;
            const completionPercentage = totalPossible > 0 ? (totalScores / totalPossible * 100).toFixed(1) : 0;

            statusContainer.innerHTML = `
                <div class="text-center">
                    <div class="text-white font-bold text-lg">${totalScores}/${totalPossible}</div>
                    <div class="text-white/60 text-xs">Scoresheets Completed</div>
                </div>
                <div class="text-center">
                    <div class="text-white font-bold text-lg">${completedJudges}/${CONFIG.judges.length}</div>
                    <div class="text-white/60 text-xs">Judges Participating</div>
                </div>
                <div class="text-center">
                    <div class="text-white font-bold text-lg">${completionPercentage}%</div>
                    <div class="text-white/60 text-xs">Overall Completion</div>
                </div>
            `;
        }

        // Show detailed scores for a contestant
        function showDetails(contestant) {
            let details = `Detailed Scores for ${contestant}:\n\n`;
            
            CONFIG.judges.forEach(judge => {
                const storageKey = `judge${judge.id}_${contestant}`;
                const savedScores = localStorage.getItem(storageKey);
                
                if (savedScores) {
                    const scores = JSON.parse(savedScores);
                    details += `${judge.name}:\n`;
                    Object.entries(scores).forEach(([category, subcategoryScores]) => {
                        const categoryTotal = Object.values(subcategoryScores).reduce((sum, score) => sum + score, 0);
                        const categoryAverage = Object.keys(subcategoryScores).length > 0 ? categoryTotal / Object.keys(subcategoryScores).length : 0;
                        details += `  ${category}: ${categoryAverage.toFixed(1)}\n`;
                    });
                    details += '\n';
                }
            });
            
            alert(details);
        }

        // Export results to CSV
        function exportToCSV() {
            calculateResults();
            
            let csv = 'Rank,Contestant,Total Score,Average Score,';
            
            // Add category headers
            Object.keys(CONFIG.categories).forEach(category => {
                CONFIG.judges.forEach(judge => {
                    csv += `${category} (${judge.name}),`;
                });
            });
            csv += '\n';

            // Get results
            const results = [];
            CONFIG.contestants.forEach(contestant => {
                let totalScore = 0;
                let judgeCount = 0;
                const judgeScores = {};

                CONFIG.judges.forEach(judge => {
                    const storageKey = `judge${judge.id}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    
                    if (savedScores) {
                        judgeCount++;
                        const scores = JSON.parse(savedScores);
                        judgeScores[judge.id] = scores;
                        Object.entries(scores).forEach(([category, subcategoryScores]) => {
                            const categoryTotal = Object.values(subcategoryScores).reduce((sum, score) => sum + score, 0);
                            const categoryAverage = Object.keys(subcategoryScores).length > 0 ? categoryTotal / Object.keys(subcategoryScores).length : 0;
                            totalScore += categoryAverage;
                        });
                    }
                });

                if (judgeCount > 0) {
                    results.push({
                        contestant,
                        totalScore,
                        averageScore: totalScore / judgeCount,
                        judgeScores
                    });
                }
            });

            results.sort((a, b) => b.totalScore - a.totalScore);

            // Add data rows
            results.forEach((result, index) => {
                csv += `${index + 1},${result.contestant},${result.totalScore.toFixed(1)},${result.averageScore.toFixed(1)},`;
                
                Object.keys(CONFIG.categories).forEach(category => {
                    CONFIG.judges.forEach(judge => {
                        if (result.judgeScores[judge.id] && result.judgeScores[judge.id][category]) {
                            const categoryTotal = Object.values(result.judgeScores[judge.id][category]).reduce((sum, score) => sum + score, 0);
                            const categoryAverage = Object.keys(result.judgeScores[judge.id][category]).length > 0 ? categoryTotal / Object.keys(result.judgeScores[judge.id][category]).length : 0;
                            csv += `${categoryAverage.toFixed(1)},`;
                        } else {
                            csv += '0,';
                        }
                    });
                });
                csv += '\n';
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pageant_results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all scoring data? This cannot be undone.')) {
                // Clear all judge scores
                CONFIG.judges.forEach(judge => {
                    CONFIG.contestants.forEach(contestant => {
                        const storageKey = `judge${judge.id}_${contestant}`;
                        localStorage.removeItem(storageKey);
                    });
                });
                alert('All data has been cleared.');
                calculateResults();
            }
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // Clean up sessions when page is closed or refreshed
        window.addEventListener('beforeunload', function() {
            if (currentPageType === 'admin') {
                unlockPage('admin');
            } else if (currentPageType === 'judge' && currentJudge) {
                unlockPage('judge', currentJudge);
            }
            
            stopHeartbeat();
            if (sessionMonitorInterval) {
                clearInterval(sessionMonitorInterval);
            }
        });

        // Update time remaining every minute
        setInterval(updateTimeRemaining, 60000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97305c400247eb9d',t:'MTc1NTg0NDYzMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
