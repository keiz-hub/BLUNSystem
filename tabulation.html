<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pageant Scoring System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom animations */
        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(360deg); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .flip-animation {
            animation: flip 3s ease-in-out infinite;
        }
        
        .fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }
        
        .pulse-hover:hover {
            animation: pulse 0.3s ease-in-out;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .locked-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <!-- Lock Overlay -->
    <div id="lockOverlay" class="locked-overlay hidden">
        <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 text-center max-w-md">
            <h3 class="text-2xl font-bold text-white mb-4">üîí Page Locked</h3>
            <p id="lockMessage" class="text-white/80 mb-6"></p>
            <div class="flex gap-4 justify-center">
                <button onclick="checkLockStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">Check Again</button>
                <button onclick="showPage('home')" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors">Go Home</button>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white/10 backdrop-blur-md border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-white">Pageant Scoring System</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showPage('home')" class="text-white hover:text-green-200 px-3 py-2 rounded-md text-sm font-medium transition-colors">Home</button>
                    <button onclick="showPage('admin')" class="text-white hover:text-green-200 px-3 py-2 rounded-md text-sm font-medium transition-colors">Admin</button>
                    <div id="sessionIndicator" class="text-xs text-white/60"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Home Page -->
    <div id="homePage" class="page">
        <div class="max-w-4xl mx-auto px-4 py-16 text-center">
            <!-- Animated Logo Placeholder -->
            <div class="mb-12 fade-in-up">
                <div class="flip-animation mx-auto w-32 h-32 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center border-4 border-white/30">
                    <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                </div>
            </div>
            
            <h1 class="text-5xl font-bold text-white mb-6 fade-in-up">Beauty Pageant</h1>
            <h2 class="text-3xl font-light text-white/90 mb-12 fade-in-up">Scoring System</h2>
            
            <div class="grid md:grid-cols-2 gap-8 mb-12">
                <!-- Judge Access Cards -->
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 card-hover fade-in-up">
                    <h3 class="text-2xl font-bold text-white mb-6">Judge Access</h3>
                    <div id="judgeButtons" class="grid grid-cols-2 gap-4">
                        <!-- Judge buttons will be generated here -->
                    </div>
                </div>
                
                <!-- Admin Access Card -->
                <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 card-hover fade-in-up">
                    <h3 class="text-2xl font-bold text-white mb-6">Administration</h3>
                    <button onclick="showAdminPage()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-lg transition-colors pulse-hover w-full">
                        View Rankings & Results
                    </button>
                </div>
            </div>

            <!-- Session Status -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 fade-in-up">
                <h3 class="text-lg font-bold text-white mb-4">Current Session Status</h3>
                <div id="sessionStatus" class="grid md:grid-cols-2 gap-4 text-sm">
                    <!-- Session status will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Judge Scoring Page -->
    <div id="judgePage" class="page hidden">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 mb-8">
                <h2 id="judgeTitle" class="text-3xl font-bold text-white mb-4">Judge Scoring Panel</h2>
                <div class="flex flex-wrap gap-4 mb-6">
                    <select id="contestantSelect" class="bg-white/20 text-white rounded-lg px-4 py-2 border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Select Contestant</option>
                    </select>
                    <button onclick="saveScores()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Save Scores</button>
                    <button onclick="showPage('home')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Back to Home</button>
                </div>
                <div id="sessionWarning" class="bg-yellow-600/20 border border-yellow-500/30 rounded-lg p-4 mb-4 hidden">
                    <p class="text-yellow-200">‚ö†Ô∏è Your session will expire in <span id="timeRemaining"></span> minutes of inactivity.</p>
                </div>
            </div>
            
            <div id="scoringForm" class="grid lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Scoring categories will be generated here -->
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="page hidden">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <!-- Admin Controls -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-8 mb-8">
                <h2 class="text-3xl font-bold text-white mb-6">Admin Dashboard</h2>
                
                <!-- Session Override -->
                <div class="bg-red-600/20 border border-red-500/30 rounded-lg p-4 mb-6">
                    <h4 class="text-white font-bold mb-2">üîì Emergency Session Management</h4>
                    <div class="flex gap-2">
                        <button onclick="forceUnlockAll()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">Force Unlock All</button>
                        <button onclick="viewActiveSessions()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">View Active Sessions</button>
                    </div>
                </div>
                
                <!-- Management Section -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <!-- Judge Management -->
                    <div class="bg-white/10 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Manage Judges</h3>
                        <div class="space-y-4">
                            <div class="flex gap-2">
                                <input type="text" id="judgeNameInput" placeholder="Judge Name (optional)" 
                                       class="flex-1 bg-white/20 text-white rounded-lg px-3 py-2 border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-white/60">
                                <button onclick="addJudge()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">Add Judge</button>
                            </div>
                            <div id="judgesList" class="space-y-2">
                                <!-- Current judges will be listed here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contestant Management -->
                    <div class="bg-white/10 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-white mb-4">Manage Contestants</h3>
                        <div class="space-y-4">
                            <div class="flex gap-2">
                                <input type="text" id="contestantNameInput" placeholder="Contestant Name" 
                                       class="flex-1 bg-white/20 text-white rounded-lg px-3 py-2 border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-white/60">
                                <button onclick="addContestant()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">Add</button>
                            </div>
                            <div id="contestantsList" class="space-y-2">
                                <!-- Current contestants will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4">
                    <button onclick="calculateResults()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Calculate Results</button>
                    <button onclick="exportToCSV()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Export CSV</button>
                    <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Clear All Data</button>
                    <button onclick="showPage('home')" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Back to Home</button>
                </div>
            </div>
            
            <!-- Results Table -->
            <div class="bg-white/10 backdrop-blur-md rounded-xl p-8">
                <h3 class="text-2xl font-bold text-white mb-6">Final Rankings</h3>
                <div class="overflow-x-auto">
                    <table id="resultsTable" class="w-full text-white">
                        <thead>
                            <tr class="border-b border-white/20">
                                <th class="text-left py-3 px-4">Rank</th>
                                <th class="text-left py-3 px-4">Contestant</th>
                                <th class="text-left py-3 px-4">Total Score</th>
                                <th class="text-left py-3 px-4">Average</th>
                                <th class="text-left py-3 px-4">Details</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced cross-device session management
        const DEVICE_ID = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const SESSION_HEARTBEAT_INTERVAL = 2000; // 2 seconds
        const SESSION_TIMEOUT = 10000; // 10 seconds timeout
        const GLOBAL_SESSION_KEY = 'pageant_global_sessions';
        
        // Configuration - Now dynamically managed
        let CONFIG = {
            contestants: [
                'Contestant 1', 'Contestant 2', 'Contestant 3', 
                'Contestant 4', 'Contestant 5', 'Contestant 6'
            ],
            judges: [
                { id: 1, name: 'Judge 1' },
                { id: 2, name: 'Judge 2' },
                { id: 3, name: 'Judge 3' },
                { id: 4, name: 'Judge 4' }
            ],
            categories: {
                'Evening Gown': ['Elegance', 'Fit', 'Style', 'Confidence', 'Overall Presentation'],
                'Swimwear': ['Fitness', 'Confidence', 'Poise', 'Stage Presence', 'Overall Appeal'],
                'Talent': ['Skill Level', 'Creativity', 'Entertainment Value', 'Stage Presence', 'Originality'],
                'Interview': ['Articulation', 'Intelligence', 'Personality', 'Confidence', 'Relevance'],
                'National Costume': ['Creativity', 'Cultural Representation', 'Craftsmanship', 'Presentation', 'Authenticity']
            }
        };

        let currentJudge = 1;
        let currentPageType = null;
        let heartbeatInterval = null;
        let sessionMonitorInterval = null;

        // Cross-device session management functions
        function getGlobalSessions() {
            const sessions = localStorage.getItem(GLOBAL_SESSION_KEY);
            return sessions ? JSON.parse(sessions) : {};
        }

        function setGlobalSessions(sessions) {
            localStorage.setItem(GLOBAL_SESSION_KEY, JSON.stringify(sessions));
        }

        function cleanExpiredSessions() {
            const sessions = getGlobalSessions();
            const now = Date.now();
            let changed = false;
            
            Object.keys(sessions).forEach(sessionKey => {
                if (now - sessions[sessionKey].lastHeartbeat > SESSION_TIMEOUT) {
                    delete sessions[sessionKey];
                    changed = true;
                }
            });
            
            if (changed) {
                setGlobalSessions(sessions);
            }
        }

        function isPageLocked(pageType, judgeId = null) {
            cleanExpiredSessions();
            const sessions = getGlobalSessions();
            const sessionKey = pageType === 'admin' ? 'admin' : `judge_${judgeId}`;
            
            const session = sessions[sessionKey];
            if (!session) return false;
            
            // Check if it's locked by a different device
            return session.deviceId !== DEVICE_ID;
        }

        function lockPage(pageType, judgeId = null) {
            cleanExpiredSessions();
            const sessions = getGlobalSessions();
            const sessionKey = pageType === 'admin' ? 'admin' : `judge_${judgeId}`;
            
            // Double-check if someone else just locked it
            if (sessions[sessionKey] && sessions[sessionKey].deviceId !== DEVICE_ID) {
                return false;
            }
            
            // Lock the page for this device
            sessions[sessionKey] = {
                deviceId: DEVICE_ID,
                pageType: pageType,
                judgeId: judgeId,
                lastHeartbeat: Date.now(),
                userAgent: navigator.userAgent.substring(0, 50),
                timestamp: Date.now()
            };
            
            setGlobalSessions(sessions);
            
            // Start heartbeat to maintain the lock
            startHeartbeat(sessionKey);
            
            return true;
        }

        function unlockPage(pageType, judgeId = null) {
            const sessions = getGlobalSessions();
            const sessionKey = pageType === 'admin' ? 'admin' : `judge_${judgeId}`;
            
            // Only unlock if this is our session
            if (sessions[sessionKey] && sessions[sessionKey].deviceId === DEVICE_ID) {
                delete sessions[sessionKey];
                setGlobalSessions(sessions);
            }
            
            stopHeartbeat();
        }

        function forceUnlockPage(pageType, judgeId = null) {
            const sessions = getGlobalSessions();
            const sessionKey = pageType === 'admin' ? 'admin' : `judge_${judgeId}`;
            delete sessions[sessionKey];
            setGlobalSessions(sessions);
        }

        function startHeartbeat(sessionKey) {
            stopHeartbeat(); // Clear any existing heartbeat
            
            heartbeatInterval = setInterval(() => {
                const sessions = getGlobalSessions();
                if (sessions[sessionKey] && sessions[sessionKey].deviceId === DEVICE_ID) {
                    sessions[sessionKey].lastHeartbeat = Date.now();
                    setGlobalSessions(sessions);
                } else {
                    // Session was taken over by another device
                    stopHeartbeat();
                    showLockOverlay(currentPageType, currentJudge);
                }
            }, SESSION_HEARTBEAT_INTERVAL);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        function startSessionMonitor() {
            sessionMonitorInterval = setInterval(() => {
                cleanExpiredSessions();
                updateSessionStatus();
                
                // Check if our current session was taken over
                if (currentPageType && currentPageType !== 'home') {
                    const sessionKey = currentPageType === 'admin' ? 'admin' : `judge_${currentJudge}`;
                    const sessions = getGlobalSessions();
                    
                    if (sessions[sessionKey] && sessions[sessionKey].deviceId !== DEVICE_ID) {
                        // Our session was taken over
                        stopHeartbeat();
                        showLockOverlay(currentPageType, currentJudge);
                    }
                }
            }, 3000);
        }

        function forceUnlockAll() {
            if (confirm('Force unlock all sessions? This will kick out all active users.')) {
                // Clear all global sessions
                setGlobalSessions({});
                
                alert('All sessions have been forcefully unlocked.');
                updateSessionStatus();
            }
        }

        function showLockOverlay(pageType, judgeId = null) {
            const overlay = document.getElementById('lockOverlay');
            const message = document.getElementById('lockMessage');
            
            if (pageType === 'admin') {
                message.textContent = 'The admin panel is currently being used by another user. Please wait for them to finish or ask an administrator to force unlock.';
            } else {
                const judge = CONFIG.judges.find(j => j.id === judgeId);
                message.textContent = `${judge.name}'s scoring panel is currently being used by another user. Please wait for them to finish.`;
            }
            
            overlay.classList.remove('hidden');
        }

        function hideLockOverlay() {
            document.getElementById('lockOverlay').classList.add('hidden');
        }

        function checkLockStatus() {
            hideLockOverlay();
            updateSessionStatus();
        }

        function viewActiveSessions() {
            cleanExpiredSessions();
            const sessions = getGlobalSessions();
            let sessionInfo = 'Active Sessions:\n\n';
            
            // Check admin session
            if (sessions.admin) {
                const timeAgo = Math.floor((Date.now() - sessions.admin.lastHeartbeat) / 1000);
                const isOurs = sessions.admin.deviceId === DEVICE_ID;
                sessionInfo += `Admin Panel: ${isOurs ? 'Your device' : 'Another device'} (${timeAgo}s ago)\n`;
            }
            
            // Check judge sessions
            CONFIG.judges.forEach(judge => {
                const sessionKey = `judge_${judge.id}`;
                if (sessions[sessionKey]) {
                    const timeAgo = Math.floor((Date.now() - sessions[sessionKey].lastHeartbeat) / 1000);
                    const isOurs = sessions[sessionKey].deviceId === DEVICE_ID;
                    sessionInfo += `${judge.name}: ${isOurs ? 'Your device' : 'Another device'} (${timeAgo}s ago)\n`;
                }
            });
            
            if (Object.keys(sessions).length === 0) {
                sessionInfo += 'No active sessions found.';
            }
            
            alert(sessionInfo);
        }

        function updateSessionStatus() {
            cleanExpiredSessions();
            const sessions = getGlobalSessions();
            const statusContainer = document.getElementById('sessionStatus');
            const indicator = document.getElementById('sessionIndicator');
            
            if (!statusContainer) return;
            
            statusContainer.innerHTML = '';
            indicator.textContent = `Device: ${DEVICE_ID.substring(0, 12)}...`;
            
            // Admin status
            const adminDiv = document.createElement('div');
            if (sessions.admin) {
                const isOurs = sessions.admin.deviceId === DEVICE_ID;
                const timeAgo = Math.floor((Date.now() - sessions.admin.lastHeartbeat) / 1000);
                adminDiv.innerHTML = `
                    <div class="flex items-center justify-between p-2 rounded ${isOurs ? 'bg-green-600/20' : 'bg-red-600/20'}">
                        <span class="text-white">Admin Panel</span>
                        <span class="text-xs ${isOurs ? 'text-green-300' : 'text-red-300'}">${isOurs ? 'Your device' : `Locked (${timeAgo}s ago)`}</span>
                    </div>
                `;
            } else {
                adminDiv.innerHTML = `
                    <div class="flex items-center justify-between p-2 rounded bg-gray-600/20">
                        <span class="text-white">Admin Panel</span>
                        <span class="text-xs text-gray-300">Available</span>
                    </div>
                `;
            }
            statusContainer.appendChild(adminDiv);
            
            // Judge statuses
            const judgeDiv = document.createElement('div');
            judgeDiv.innerHTML = '<div class="space-y-1">';
            CONFIG.judges.forEach(judge => {
                const sessionKey = `judge_${judge.id}`;
                if (sessions[sessionKey]) {
                    const isOurs = sessions[sessionKey].deviceId === DEVICE_ID;
                    const timeAgo = Math.floor((Date.now() - sessions[sessionKey].lastHeartbeat) / 1000);
                    judgeDiv.innerHTML += `
                        <div class="flex items-center justify-between p-2 rounded ${isOurs ? 'bg-green-600/20' : 'bg-red-600/20'}">
                            <span class="text-white">${judge.name}</span>
                            <span class="text-xs ${isOurs ? 'text-green-300' : 'text-red-300'}">${isOurs ? 'Your device' : `Locked (${timeAgo}s ago)`}</span>
                        </div>
                    `;
                } else {
                    judgeDiv.innerHTML += `
                        <div class="flex items-center justify-between p-2 rounded bg-gray-600/20">
                            <span class="text-white">${judge.name}</span>
                            <span class="text-xs text-gray-300">Available</span>
                        </div>
                    `;
                }
            });
            judgeDiv.innerHTML += '</div>';
            statusContainer.appendChild(judgeDiv);
        }

        // Load configuration from localStorage or use defaults
        function loadConfig() {
            const savedConfig = localStorage.getItem('pageant_config');
            if (savedConfig) {
                CONFIG = { ...CONFIG, ...JSON.parse(savedConfig) };
            }
        }

        // Save configuration to localStorage
        function saveConfig() {
            localStorage.setItem('pageant_config', JSON.stringify({
                contestants: CONFIG.contestants,
                judges: CONFIG.judges
            }));
        }

        // Initialize the application
        function initApp() {
            loadConfig();
            updateJudgeButtons();
            populateContestantSelect();
            updateJudgesList();
            updateContestantsList();
            updateSessionStatus();
            showPage('home');
            
            // Start session monitoring
            startSessionMonitor();
        }

        // Update judge buttons on home page
        function updateJudgeButtons() {
            const container = document.getElementById('judgeButtons');
            container.innerHTML = '';
            
            CONFIG.judges.forEach(judge => {
                const button = document.createElement('button');
                button.onclick = () => showJudgePage(judge.id);
                button.className = 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors pulse-hover';
                button.textContent = judge.name;
                container.appendChild(button);
            });
        }

        // Add new judge
        function addJudge() {
            const nameInput = document.getElementById('judgeNameInput');
            const judgeName = nameInput.value.trim() || `Judge ${CONFIG.judges.length + 1}`;
            const newId = Math.max(...CONFIG.judges.map(j => j.id), 0) + 1;
            
            CONFIG.judges.push({ id: newId, name: judgeName });
            nameInput.value = '';
            
            saveConfig();
            updateJudgeButtons();
            updateJudgesList();
            updateSessionStatus();
        }

        // Remove judge
        function removeJudge(judgeId) {
            if (CONFIG.judges.length <= 1) {
                alert('You must have at least one judge!');
                return;
            }
            
            if (confirm('Are you sure you want to remove this judge? All their scores will be deleted.')) {
                // Force unlock the judge's session
                forceUnlockPage('judge', judgeId);
                
                // Remove judge from config
                CONFIG.judges = CONFIG.judges.filter(j => j.id !== judgeId);
                
                // Clear all scores for this judge
                CONFIG.contestants.forEach(contestant => {
                    const storageKey = `judge${judgeId}_${contestant}`;
                    localStorage.removeItem(storageKey);
                });
                
                saveConfig();
                updateJudgeButtons();
                updateJudgesList();
                updateSessionStatus();
                calculateResults();
            }
        }

        // Update judges list in admin
        function updateJudgesList() {
            const container = document.getElementById('judgesList');
            container.innerHTML = '';
            
            CONFIG.judges.forEach(judge => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-white/10 rounded px-3 py-2';
                div.innerHTML = `
                    <span class="text-white">${judge.name}</span>
                    <button onclick="removeJudge(${judge.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm transition-colors">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        // Add new contestant
        function addContestant() {
            const nameInput = document.getElementById('contestantNameInput');
            const contestantName = nameInput.value.trim();
            
            if (!contestantName) {
                alert('Please enter a contestant name!');
                return;
            }
            
            if (CONFIG.contestants.includes(contestantName)) {
                alert('This contestant already exists!');
                return;
            }
            
            CONFIG.contestants.push(contestantName);
            nameInput.value = '';
            
            saveConfig();
            populateContestantSelect();
            updateContestantsList();
        }

        // Remove contestant
        function removeContestant(contestantName) {
            if (CONFIG.contestants.length <= 1) {
                alert('You must have at least one contestant!');
                return;
            }
            
            if (confirm('Are you sure you want to remove this contestant? All their scores will be deleted.')) {
                // Remove contestant from config
                CONFIG.contestants = CONFIG.contestants.filter(c => c !== contestantName);
                
                // Clear all scores for this contestant
                CONFIG.judges.forEach(judge => {
                    const storageKey = `judge${judge.id}_${contestantName}`;
                    localStorage.removeItem(storageKey);
                });
                
                saveConfig();
                populateContestantSelect();
                updateContestantsList();
                calculateResults();
            }
        }

        // Update contestants list in admin
        function updateContestantsList() {
            const container = document.getElementById('contestantsList');
            container.innerHTML = '';
            
            CONFIG.contestants.forEach(contestant => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-white/10 rounded px-3 py-2';
                div.innerHTML = `
                    <span class="text-white">${contestant}</span>
                    <button onclick="removeContestant('${contestant}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm transition-colors">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        // Show specific page
        function showPage(pageType) {
            // Unlock current page when navigating away
            if (currentPageType === 'admin') {
                unlockPage('admin');
            } else if (currentPageType === 'judge' && currentJudge) {
                unlockPage('judge', currentJudge);
            }
            
            hideLockOverlay();
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            
            if (pageType === 'home') {
                document.getElementById('homePage').classList.remove('hidden');
                currentPageType = 'home';
                currentJudge = null;
                updateSessionStatus();
            } else if (pageType === 'admin') {
                showAdminPage();
            }
        }

        // Show admin page directly
        function showAdminPage() {
            if (isPageLocked('admin')) {
                showLockOverlay('admin');
                return;
            }
            
            if (!lockPage('admin')) {
                showLockOverlay('admin');
                return;
            }
            
            hideLockOverlay();
            currentPageType = 'admin';
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById('adminPage').classList.remove('hidden');
            updateJudgesList();
            updateContestantsList();
            calculateResults();
        }

        // Show judge scoring page
        function showJudgePage(judgeId) {
            if (isPageLocked('judge', judgeId)) {
                showLockOverlay('judge', judgeId);
                return;
            }
            
            if (!lockPage('judge', judgeId)) {
                showLockOverlay('judge', judgeId);
                return;
            }
            
            hideLockOverlay();
            currentPageType = 'judge';
            currentJudge = judgeId;
            const judge = CONFIG.judges.find(j => j.id === judgeId);
            document.getElementById('judgeTitle').textContent = `${judge.name} - Scoring Panel`;
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById('judgePage').classList.remove('hidden');
            generateScoringForm();
            loadExistingScores();
            
            // Show session warning
            document.getElementById('sessionWarning').classList.remove('hidden');
            updateTimeRemaining();
        }

        function updateTimeRemaining() {
            const timeSpan = document.getElementById('timeRemaining');
            if (timeSpan && currentPageType === 'judge' && currentJudge) {
                const sessions = getGlobalSessions();
                const sessionKey = `judge_${currentJudge}`;
                if (sessions[sessionKey] && sessions[sessionKey].deviceId === DEVICE_ID) {
                    const secondsLeft = Math.floor((SESSION_TIMEOUT - (Date.now() - sessions[sessionKey].lastHeartbeat)) / 1000);
                    const minutesLeft = Math.floor(secondsLeft / 60);
                    timeSpan.textContent = Math.max(0, minutesLeft);
                }
            }
        }

        // Populate contestant dropdown
        function populateContestantSelect() {
            const select = document.getElementById('contestantSelect');
            if (!select) return;
            select.innerHTML = '<option value="">Select Contestant</option>';
            CONFIG.contestants.forEach(contestant => {
                const option = document.createElement('option');
                option.value = contestant;
                option.textContent = contestant;
                select.appendChild(option);
            });
        }

        // Generate scoring form for current judge
        function generateScoringForm() {
            const form = document.getElementById('scoringForm');
            form.innerHTML = '';

            Object.entries(CONFIG.categories).forEach(([category, subcategories]) => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'bg-white/10 backdrop-blur-md rounded-xl p-6 card-hover';
                
                let subcategoryInputs = '';
                subcategories.forEach(subcategory => {
                    subcategoryInputs += `
                        <div class="mb-4">
                            <label class="block text-white text-sm font-medium mb-2">${subcategory}</label>
                            <input type="number" 
                                   min="0" max="10" step="0.1"
                                   class="w-full bg-white/20 text-white rounded-lg px-3 py-2 border border-white/30 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                   data-category="${category}" 
                                   data-subcategory="${subcategory}"
                                   placeholder="0-10">
                        </div>
                    `;
                });

                categoryCard.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-4 border-b border-white/20 pb-2">${category}</h3>
                    ${subcategoryInputs}
                    <div class="mt-4 p-3 bg-white/10 rounded-lg">
                        <span class="text-white font-medium">Category Total: </span>
                        <span id="total-${category.replace(/\s+/g, '')}" class="text-purple-300 font-bold">0.0</span>
                    </div>
                `;

                form.appendChild(categoryCard);
            });

            // Add event listeners for real-time calculation
            form.addEventListener('input', calculateCategoryTotals);
        }

        // Calculate category totals in real-time
        function calculateCategoryTotals() {
            Object.keys(CONFIG.categories).forEach(category => {
                const inputs = document.querySelectorAll(`input[data-category="${category}"]`);
                let total = 0;
                inputs.forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                const totalElement = document.getElementById(`total-${category.replace(/\s+/g, '')}`);
                if (totalElement) {
                    totalElement.textContent = total.toFixed(1);
                }
            });
        }

        // Save scores to local storage
        function saveScores() {
            const contestant = document.getElementById('contestantSelect').value;
            if (!contestant) {
                alert('Please select a contestant first!');
                return;
            }

            const scores = {};
            Object.entries(CONFIG.categories).forEach(([category, subcategories]) => {
                scores[category] = {};
                subcategories.forEach(subcategory => {
                    const input = document.querySelector(`input[data-category="${category}"][data-subcategory="${subcategory}"]`);
                    scores[category][subcategory] = parseFloat(input.value) || 0;
                });
            });

            // Save to local storage
            const storageKey = `judge${currentJudge}_${contestant}`;
            localStorage.setItem(storageKey, JSON.stringify(scores));
            
            alert(`Scores saved successfully for ${contestant}!`);
        }

        // Load existing scores for selected contestant
        function loadExistingScores() {
            const select = document.getElementById('contestantSelect');
            if (!select) return;
            
            select.addEventListener('change', function() {
                const contestant = this.value;
                if (!contestant) return;

                const storageKey = `judge${currentJudge}_${contestant}`;
                const savedScores = localStorage.getItem(storageKey);
                
                if (savedScores) {
                    const scores = JSON.parse(savedScores);
                    Object.entries(scores).forEach(([category, subcategoryScores]) => {
                        Object.entries(subcategoryScores).forEach(([subcategory, score]) => {
                            const input = document.querySelector(`input[data-category="${category}"][data-subcategory="${subcategory}"]`);
                            if (input) {
                                input.value = score;
                            }
                        });
                    });
                    calculateCategoryTotals();
                }
            });
        }

        // Calculate final results
        function calculateResults() {
            const results = [];

            CONFIG.contestants.forEach(contestant => {
                let totalScore = 0;
                let judgeCount = 0;
                const categoryTotals = {};

                // Initialize category totals
                Object.keys(CONFIG.categories).forEach(category => {
                    categoryTotals[category] = 0;
                });

                // Collect scores from all judges
                CONFIG.judges.forEach(judge => {
                    const storageKey = `judge${judge.id}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    
                    if (savedScores) {
                        judgeCount++;
                        const scores = JSON.parse(savedScores);
                        Object.entries(scores).forEach(([category, subcategoryScores]) => {
                            const categoryTotal = Object.values(subcategoryScores).reduce((sum, score) => sum + score, 0);
                            categoryTotals[category] += categoryTotal;
                            totalScore += categoryTotal;
                        });
                    }
                });

                if (judgeCount > 0) {
                    results.push({
                        contestant,
                        totalScore,
                        averageScore: totalScore / judgeCount,
                        judgeCount,
                        categoryTotals
                    });
                }
            });

            // Sort by total score (descending)
            results.sort((a, b) => b.totalScore - a.totalScore);

            displayResults(results);
        }

        // Display results in the admin table
        function displayResults(results) {
            const tbody = document.getElementById('resultsBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            results.forEach((result, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-white/10 hover:bg-white/5 transition-colors';
                
                // Add special styling for top 3
                let rankDisplay = index + 1;
                let rankClass = '';
                if (index === 0) {
                    rankClass = 'text-yellow-400 font-bold'; // Gold
                    rankDisplay = 'ü•á 1st';
                } else if (index === 1) {
                    rankClass = 'text-gray-300 font-bold'; // Silver
                    rankDisplay = 'ü•à 2nd';
                } else if (index === 2) {
                    rankClass = 'text-yellow-600 font-bold'; // Bronze
                    rankDisplay = 'ü•â 3rd';
                }

                row.innerHTML = `
                    <td class="py-3 px-4 ${rankClass}">${rankDisplay}</td>
                    <td class="py-3 px-4 font-medium">${result.contestant}</td>
                    <td class="py-3 px-4 font-bold text-purple-400">${result.totalScore.toFixed(1)}</td>
                    <td class="py-3 px-4">${result.averageScore.toFixed(1)}</td>
                    <td class="py-3 px-4">
                        <button onclick="showDetails('${result.contestant}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            View Details
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Show detailed scores for a contestant
        function showDetails(contestant) {
            let details = `Detailed Scores for ${contestant}:\n\n`;
            
            CONFIG.judges.forEach(judge => {
                const storageKey = `judge${judge.id}_${contestant}`;
                const savedScores = localStorage.getItem(storageKey);
                
                if (savedScores) {
                    const scores = JSON.parse(savedScores);
                    details += `${judge.name}:\n`;
                    Object.entries(scores).forEach(([category, subcategoryScores]) => {
                        const categoryTotal = Object.values(subcategoryScores).reduce((sum, score) => sum + score, 0);
                        details += `  ${category}: ${categoryTotal.toFixed(1)}\n`;
                    });
                    details += '\n';
                }
            });
            
            alert(details);
        }

        // Export results to CSV
        function exportToCSV() {
            calculateResults();
            
            let csv = 'Rank,Contestant,Total Score,Average Score,';
            
            // Add category headers
            Object.keys(CONFIG.categories).forEach(category => {
                CONFIG.judges.forEach(judge => {
                    csv += `${category} (${judge.name}),`;
                });
            });
            csv += '\n';

            // Get results
            const results = [];
            CONFIG.contestants.forEach(contestant => {
                let totalScore = 0;
                let judgeCount = 0;
                const judgeScores = {};

                CONFIG.judges.forEach(judge => {
                    const storageKey = `judge${judge.id}_${contestant}`;
                    const savedScores = localStorage.getItem(storageKey);
                    
                    if (savedScores) {
                        judgeCount++;
                        const scores = JSON.parse(savedScores);
                        judgeScores[judge.id] = scores;
                        Object.entries(scores).forEach(([category, subcategoryScores]) => {
                            const categoryTotal = Object.values(subcategoryScores).reduce((sum, score) => sum + score, 0);
                            totalScore += categoryTotal;
                        });
                    }
                });

                if (judgeCount > 0) {
                    results.push({
                        contestant,
                        totalScore,
                        averageScore: totalScore / judgeCount,
                        judgeScores
                    });
                }
            });

            results.sort((a, b) => b.totalScore - a.totalScore);

            // Add data rows
            results.forEach((result, index) => {
                csv += `${index + 1},${result.contestant},${result.totalScore.toFixed(1)},${result.averageScore.toFixed(1)},`;
                
                Object.keys(CONFIG.categories).forEach(category => {
                    CONFIG.judges.forEach(judge => {
                        if (result.judgeScores[judge.id] && result.judgeScores[judge.id][category]) {
                            const categoryTotal = Object.values(result.judgeScores[judge.id][category]).reduce((sum, score) => sum + score, 0);
                            csv += `${categoryTotal.toFixed(1)},`;
                        } else {
                            csv += '0,';
                        }
                    });
                });
                csv += '\n';
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pageant_results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all scoring data? This cannot be undone.')) {
                // Clear all judge scores
                CONFIG.judges.forEach(judge => {
                    CONFIG.contestants.forEach(contestant => {
                        const storageKey = `judge${judge.id}_${contestant}`;
                        localStorage.removeItem(storageKey);
                    });
                });
                alert('All data has been cleared.');
                calculateResults();
            }
        }

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // Clean up sessions when page is closed or refreshed
        window.addEventListener('beforeunload', function() {
            if (currentPageType === 'admin') {
                unlockPage('admin');
            } else if (currentPageType === 'judge' && currentJudge) {
                unlockPage('judge', currentJudge);
            }
            
            stopHeartbeat();
            if (sessionMonitorInterval) {
                clearInterval(sessionMonitorInterval);
            }
        });

        // Update time remaining every minute
        setInterval(updateTimeRemaining, 60000);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972f78aec50ece2b',t:'MTc1NTgzNTMxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
